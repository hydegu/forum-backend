# Nacos配置文件示例：forum-gateway.yaml
# 配置中心：Nacos
# 命名空间：public
# 分组：DEFAULT_GROUP
# Data ID：forum-gateway.yaml

server:
  port: 9090

# JWT配置（白名单）
com:
  jwt:
    # 不需要JWT验证的路径列表（公开接口）
    whitelist:
      # ========== 用户服务公开接口 ==========
      - /api/user/login                        # 登录
      - /api/user/register                     # 注册
      - /api/user/send-verification-email      # 发送验证码
      - /api/user/validate-verification-code   # 验证验证码
      - /api/user/health                       # 健康检查
      
      # ========== 认证服务公开接口 ==========
      - /api/auth/refresh                      # 刷新token
      - /api/auth/password-reset/**            # 密码重置（所有子路径）
      - /api/logout                            # 登出
      - /api/auth/logout                       # 登出（备用）
      
      # ========== 监控和健康检查 ==========
      - /actuator/health                       # 健康检查
      - /actuator/info                         # 服务信息
      - /actuator/prometheus                   # Prometheus监控
      - /actuator/metrics/**                   # 指标数据
      
      # ========== 帖子服务公开接口（可选）==========
      # 如果帖子列表和详情不需要登录即可访问，取消下面的注释
      # - /api/post/list                       # 帖子列表
      # - /api/post/detail/**                  # 帖子详情
      # - /api/post/*/view                     # 浏览帖子（增加浏览量）
      # - /api/post/hot                        # 热门帖子
      # - /api/post/search                     # 搜索帖子
      
      # ========== 评论服务公开接口（可选）==========
      # 如果评论列表不需要登录即可访问，取消下面的注释
      # - /api/comment/list                    # 评论列表
      # - /api/comment/post/*/comments         # 获取帖子的评论

spring:
  cloud:
    gateway:
      routes:
        # ========== 用户服务路由 ==========
        - id: user-service
          uri: lb://forum-user-service
          predicates:
            - Path=/api/user/**
          filters:
            - StripPrefix=1
        
        # ========== 帖子服务路由 ==========
        - id: post-service
          uri: lb://forum-post-service
          predicates:
            - Path=/api/post/**
          filters:
            - StripPrefix=1
        
        # ========== 评论服务路由 ==========
        - id: comment-service
          uri: lb://forum-comment-service
          predicates:
            - Path=/api/comment/**
          filters:
            - StripPrefix=1
      
      # 全局CORS配置（如果前端需要跨域）
      globalcors:
        cors-configurations:
          '[/**]':
            allowedOriginPatterns: "*"
            allowedMethods: "*"
            allowedHeaders: "*"
            allowCredentials: true
            maxAge: 3600

# ========== 配置说明 ==========
# 1. whitelist配置的路径支持Ant风格匹配：
#    - * ：匹配0个或多个字符（不包括/）
#    - **：匹配0个或多个路径段
#    - ? ：匹配单个字符
#
# 2. 路径示例：
#    - /api/login           → 精确匹配
#    - /api/user/*          → 匹配 /api/user/login、/api/user/register
#    - /api/user/**         → 匹配 /api/user/a/b/c 等所有子路径
#    - /api/post/*/view     → 匹配 /api/post/123/view
#
# 3. 安全建议：
#    - 只添加真正需要公开的接口到白名单
#    - 定期审查白名单配置
#    - 生产环境使用HTTPS
#    - 确保微服务端口不对外暴露
#
# 4. 配置热更新：
#    - 修改此配置后，网关会自动刷新
#    - 无需重启服务
